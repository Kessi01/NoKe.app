<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoKe Passwortmanager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#000000',
                        darkgray: '#111111',
                        gold: '#C49C48',
                        goldhover: '#a37f36',
                        offwhite: '#e5e5e5'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #000000;
            color: #e5e5e5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #000000;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #C49C48;
        }

        .input-field {
            background-color: #111111;
            border: 1px solid #333;
            color: white;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #C49C48;
            box-shadow: 0 0 0 1px #C49C48;
        }

        .btn-gold {
            background-color: #C49C48;
            color: black;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-gold:hover {
            background-color: #a37f36;
            transform: translateY(-1px);
        }

        .sidebar-link {
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background-color: #111111;
            border-left-color: #C49C48;
            color: #C49C48;
        }

        .strength-bar {
            transition: width 0.3s ease-in-out, background-color 0.3s;
        }

        #loading-overlay {
            backdrop-filter: blur(2px);
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">

    <!-- TOAST -->
    <div id="toast"
        class="fixed top-5 right-5 bg-darkgray border-l-4 border-gold text-white px-6 py-4 rounded shadow-2xl transform translate-x-full transition-transform duration-300 z-50">
        <span id="toast-message">Nachricht</span>
    </div>

    <!-- LOADING -->
    <div id="loading-overlay"
        class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gold"></div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-100">
        <div class="bg-darkgray p-8 rounded-xl shadow-2xl border border-gray-800 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gold tracking-wider mb-2">NoKe</h1>
                <p class="text-gray-400 text-sm">Sicherer Passwortmanager (Azure Cloud)</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-xs text-gold uppercase tracking-widest mb-1">Benutzername</label>
                    <input type="text" id="login-user" class="input-field w-full p-3 rounded"
                        placeholder="Ihr Benutzername" required>
                </div>
                <div>
                    <label class="block text-xs text-gold uppercase tracking-widest mb-1">Passwort</label>
                    <input type="password" id="login-pass" class="input-field w-full p-3 rounded" placeholder="••••••••"
                        required>
                </div>
                <button type="submit" class="btn-gold w-full py-3 rounded mt-4">Anmelden</button>
                <p class="text-center text-sm text-gray-400 mt-4">
                    Noch kein Konto? <a href="#" onclick="toggleAuth('register')"
                        class="text-gold hover:underline">Registrieren</a>
                </p>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="space-y-6 hidden">
                <div>
                    <label class="block text-xs text-gold uppercase tracking-widest mb-1">Neuer Benutzername</label>
                    <input type="text" id="reg-user" class="input-field w-full p-3 rounded"
                        placeholder="Wählen Sie einen Namen" required>
                </div>
                <div>
                    <label class="block text-xs text-gold uppercase tracking-widest mb-1">Master-Passwort</label>
                    <input type="password" id="reg-pass" class="input-field w-full p-3 rounded"
                        placeholder="Sicheres Passwort wählen" required>
                </div>
                <div>
                    <label class="block text-xs text-gold uppercase tracking-widest mb-1">Passwort bestätigen</label>
                    <input type="password" id="reg-pass-confirm" class="input-field w-full p-3 rounded"
                        placeholder="Passwort wiederholen" required>
                </div>
                <div>
                    <label class="block text-xs text-gold uppercase tracking-widest mb-1">Telefonnummer (für
                        MFA)</label>
                    <input type="tel" id="reg-phone" class="input-field w-full p-3 rounded"
                        placeholder="+41 79 123 45 67" required>
                </div>
                <button type="submit" class="btn-gold w-full py-3 rounded mt-4">Konto erstellen</button>
                <p class="text-center text-sm text-gray-400 mt-4">
                    Bereits registriert? <a href="#" onclick="toggleAuth('login')"
                        class="text-gold hover:underline">Anmelden</a>
                </p>
            </form>
        </div>
    </div>

    <!-- MFA MODAL -->
    <div id="mfa-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-90">
        <div class="bg-darkgray p-8 rounded-xl shadow-2xl border border-gray-800 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gold mb-4 text-center">MFA Verifizierung</h2>
            <p class="text-gray-400 text-sm mb-6 text-center">Bitte geben Sie den Code ein, der an Ihre Nummer gesendet
                wurde.</p>
            <form id="mfa-form" class="space-y-4">
                <input type="text" id="mfa-code"
                    class="input-field w-full p-3 rounded text-center text-2xl tracking-widest" placeholder="123456"
                    required maxlength="6">
                <button type="submit" class="btn-gold w-full py-3 rounded">Verifizieren</button>
                <button type="button" onclick="cancelMfa()"
                    class="text-gray-500 text-sm w-full mt-2 hover:text-white">Abbrechen</button>
            </form>
        </div>
    </div>

    <!-- APP INTERFACE -->
    <div id="app-interface" class="flex h-full hidden">
        <!-- Sidebar -->
        <div class="w-64 bg-darkgray border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <h2 class="text-xl font-bold text-gold">NoKe <span class="text-xs text-gray-500 font-normal">v1.0</span>
                </h2>
                <p id="user-display" class="text-xs text-gray-400 mt-1">Angemeldet</p>
            </div>
            <div class="p-4 flex-1 overflow-y-auto space-y-2" id="folder-list">
                <!-- Folders injected here -->
            </div>
            <div class="p-4 border-t border-gray-800">
                <button onclick="openFolderModal()"
                    class="w-full py-2 border border-gray-700 rounded text-gray-300 hover:border-gold hover:text-gold transition-colors text-sm">
                    <i class="fas fa-plus mr-2"></i> Neuer Ordner
                </button>
                <button onclick="logout()" class="w-full mt-3 py-2 text-red-500 hover:text-red-400 text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i> Abmelden
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col bg-black">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-darkgray">
                <div>
                    <h2 class="text-2xl font-bold text-white" id="current-folder-title">Alle</h2>
                    <p class="text-sm text-gray-400" id="entry-count">0 Einträge</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-500"></i>
                        <input type="text" id="search-input" placeholder="Suchen..."
                            class="bg-black border border-gray-700 text-white pl-10 pr-4 py-2 rounded-full focus:border-gold focus:outline-none w-64">
                    </div>
                    <button onclick="openPasswordModal()"
                        class="btn-gold px-6 py-2 rounded-full shadow-lg flex items-center">
                        <i class="fas fa-plus mr-2"></i> Neu
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 relative">
                <div id="password-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards injected here -->
                </div>

                <!-- Empty State -->
                <div id="empty-state"
                    class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                    <i class="fas fa-safe text-6xl mb-4 text-gray-700"></i>
                    <p class="text-lg">Keine Einträge gefunden</p>
                    <button onclick="openPasswordModal()" class="mt-4 text-gold hover:underline">Ersten Eintrag
                        erstellen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PASSWORD MODAL -->
    <div id="password-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80">
        <div class="bg-darkgray p-6 rounded-xl shadow-2xl border border-gray-800 w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white" id="modal-title">Neues Passwort</h3>
                <button onclick="closeModal('password-modal')" class="text-gray-500 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="password-form" class="space-y-4">
                <input type="hidden" id="entry-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Titel</label>
                        <input type="text" id="entry-name" class="input-field w-full p-2 rounded" required>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Ordner</label>
                        <select id="entry-folder" class="input-field w-full p-2 rounded">
                            <!-- Options injected -->
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase mb-1">URL (Optional)</label>
                    <input type="text" id="entry-url" class="input-field w-full p-2 rounded"
                        placeholder="https://example.com">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase mb-1">Benutzername</label>
                    <input type="text" id="entry-username" class="input-field w-full p-2 rounded">
                </div>
                <div class="relative">
                    <label class="block text-xs text-gray-400 uppercase mb-1">Passwort</label>
                    <div class="flex">
                        <input type="text" id="entry-password" class="input-field w-full p-2 rounded-l border-r-0"
                            required oninput="checkStrength(this.value)">
                        <button type="button" onclick="generatePassword()"
                            class="bg-gray-800 border border-l-0 border-gray-700 text-gold px-3 rounded-r hover:bg-gray-700"
                            title="Generieren">
                            <i class="fas fa-dice"></i>
                        </button>
                    </div>
                    <!-- Strength Meter -->
                    <div class="h-1 w-full bg-gray-800 mt-1 rounded overflow-hidden">
                        <div id="strength-meter" class="h-full strength-bar bg-red-500" style="width: 0%"></div>
                    </div>
                    <p id="strength-text" class="text-xs text-right text-gray-500 mt-1">Stärke: Leer</p>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase mb-1">Passwort bestätigen</label>
                    <input type="text" id="entry-password-confirm" class="input-field w-full p-2 rounded" required>
                </div>

                <div class="pt-2">
                    <label class="block text-xs text-gray-500 mb-1">Generator Länge: <span
                            id="slider-val">16</span></label>
                    <input type="range" id="pass-length" min="8" max="32" value="16" class="w-full accent-gold">
                </div>

                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('password-modal')"
                        class="px-4 py-2 text-gray-400 hover:text-white">Abbrechen</button>
                    <button type="submit" class="btn-gold px-6 py-2 rounded">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- FOLDER MODAL -->
    <div id="folder-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80">
        <div class="bg-darkgray p-6 rounded-xl shadow-2xl border border-gray-800 w-full max-w-sm">
            <h3 class="text-xl font-bold text-white mb-4">Neuer Ordner</h3>
            <form onsubmit="createFolder(event)">
                <input type="text" id="new-folder-name" class="input-field w-full p-2 rounded mb-4"
                    placeholder="Ordnername" required>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('folder-modal')"
                        class="px-4 py-2 text-gray-400 hover:text-white">Abbrechen</button>
                    <button type="submit" class="btn-gold px-6 py-2 rounded">Erstellen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DELETE MODAL -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80">
        <div class="bg-darkgray p-6 rounded-xl shadow-2xl border border-gray-800 w-full max-w-sm text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">Löschen bestätigen</h3>
            <p id="delete-modal-text" class="text-gray-400 mb-6">Sind Sie sicher?</p>
            <div class="flex justify-center space-x-3">
                <button onclick="closeModal('delete-modal')"
                    class="px-4 py-2 text-gray-400 hover:text-white">Abbrechen</button>
                <button onclick="confirmDelete()"
                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded font-bold">Löschen</button>
            </div>
        </div>
    </div>

    <script>
        // STATE
        let currentUser = null;
        let currentFolder = 'Alle';
        let foldersData = [];
        let entriesData = [];
        let deleteTarget = null;

        // UI REFS
        const authScreen = document.getElementById('auth-screen');
        const appInterface = document.getElementById('app-interface');
        const folderList = document.getElementById('folder-list');
        const passwordGrid = document.getElementById('password-grid');
        const mfaModal = document.getElementById('mfa-modal');

        // API HELPER
        async function apiRequest(endpoint, method, body) {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(`/api/${endpoint}`, options);
                return await response.json();
            } catch (error) {
                console.error(error);
                return { success: false, message: error.message };
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // AUTH
        function toggleAuth(mode) {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            if (mode === 'register') {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
            } else {
                loginForm.classList.remove('hidden');
                regForm.classList.add('hidden');
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;

            const result = await apiRequest('auth', 'POST', {
                action: 'login',
                username: user,
                password: pass
            });

            if (result && result.success) {
                currentUser = result.username;
                document.getElementById('user-display').textContent = currentUser;
                authScreen.classList.add('hidden');
                appInterface.classList.remove('hidden');
                loadApp();
            } else if (result && result.mfaRequired) {
                // MFA Flow
                currentUser = user; // Temporary store
                authScreen.classList.add('hidden');
                mfaModal.classList.remove('hidden');
                showToast(result.message || 'MFA Code gesendet');
            } else {
                showToast(result?.message || 'Anmeldung fehlgeschlagen', 'error');
            }
        });

        document.getElementById('mfa-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('mfa-code').value;

            const result = await apiRequest('auth', 'POST', {
                action: 'verify-mfa',
                username: currentUser,
                code: code
            });

            if (result && result.success) {
                mfaModal.classList.add('hidden');
                appInterface.classList.remove('hidden');
                document.getElementById('user-display').textContent = currentUser;
                loadApp();
            } else {
                showToast(result?.message || 'Code ungültig', 'error');
            }
        });

        function cancelMfa() {
            mfaModal.classList.add('hidden');
            authScreen.classList.remove('hidden');
            currentUser = null;
        }

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('reg-user').value;
            const pass = document.getElementById('reg-pass').value;
            const passConfirm = document.getElementById('reg-pass-confirm').value;
            const phone = document.getElementById('reg-phone').value;

            if (pass !== passConfirm) {
                showToast('Passwörter stimmen nicht überein!', 'error');
                return;
            }

            const result = await apiRequest('auth', 'POST', {
                action: 'register',
                username: user,
                password: pass,
                phoneNumber: phone
            });

            if (result && result.success) {
                showToast('Konto erstellt! Bitte anmelden.');
                toggleAuth('login');
                document.getElementById('register-form').reset();
            } else {
                showToast(result?.message || 'Registrierung fehlgeschlagen', 'error');
            }
        });

        function logout() {
            currentUser = null;
            currentFolder = 'Alle';
            foldersData = [];
            entriesData = [];
            authScreen.classList.remove('hidden');
            appInterface.classList.add('hidden');
            document.getElementById('login-form').reset();
        }

        // DATA
        async function loadApp() {
            const data = await apiRequest(`data?username=${encodeURIComponent(currentUser)}`, 'GET');
            if (data) {
                foldersData = data.folders || [];
                entriesData = data.entries || [];
                renderFolders();
                renderPasswords();
            }
        }

        // FOLDERS
        function renderFolders() {
            let html = `
            <div class="sidebar-link rounded px-4 py-2 cursor-pointer flex items-center justify-between ${currentFolder === 'Alle' ? 'active' : ''}" onclick="switchFolder('Alle')">
                <span class="text-sm font-medium"><i class="fas fa-layer-group mr-3 w-4"></i> Alle</span>
            </div>`;

            foldersData.forEach(folder => {
                const fName = typeof folder === 'string' ? folder : folder.name;
                html += `
                <div class="sidebar-link rounded px-4 py-2 cursor-pointer flex items-center justify-between ${currentFolder === fName ? 'active' : ''}" onclick="switchFolder('${fName}')">
                    <span class="text-sm font-medium"><i class="far fa-folder mr-3 w-4"></i> ${fName}</span>
                    <button onclick="initiateDeleteFolder('${fName}', event)" class="text-xs text-gray-600 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button>
                </div>`;
            });
            folderList.innerHTML = html;

            const select = document.getElementById('entry-folder');
            select.innerHTML = '<option value="Alle">Alle</option>';
            foldersData.forEach(f => {
                const fName = typeof f === 'string' ? f : f.name;
                select.innerHTML += `<option value="${fName}">${fName}</option>`;
            });
        }

        function switchFolder(folderName) {
            currentFolder = folderName;
            renderFolders();
            renderPasswords();
        }

        async function createFolder(e) {
            e.preventDefault();
            const name = document.getElementById('new-folder-name').value;
            if (!name) return;
            const result = await apiRequest('folders', 'POST', { username: currentUser, folderName: name });
            if (result && result.success) {
                foldersData.push(name);
                closeModal('folder-modal');
                document.getElementById('new-folder-name').value = '';
                renderFolders();
                showToast(`Ordner "${name}" erstellt`);
            }
        }

        function initiateDeleteFolder(folderName, event) {
            event.stopPropagation();
            deleteTarget = { type: 'folder', id: folderName };
            document.getElementById('delete-modal-text').textContent = `Ordner "${folderName}" löschen?`;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        // ENTRIES
        function renderPasswords() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filtered = entriesData.filter(entry => {
                const isFolder = currentFolder === 'Alle' || entry.folder === currentFolder;
                const isSearch = (entry.name || '').toLowerCase().includes(searchTerm) ||
                    (entry.username || '').toLowerCase().includes(searchTerm) ||
                    (entry.url || '').toLowerCase().includes(searchTerm);
                return isFolder && isSearch;
            });

            document.getElementById('current-folder-title').textContent = currentFolder;
            document.getElementById('entry-count').textContent = `${filtered.length} Einträge`;
            passwordGrid.innerHTML = '';

            if (filtered.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
                filtered.forEach(entry => passwordGrid.innerHTML += createCardHTML(entry));
            }
        }

        function createCardHTML(entry) {
            let urlHtml = '';
            if (entry.url && entry.url.trim() !== '') {
                let safeUrl = entry.url.startsWith('http') ? entry.url : 'https://' + entry.url;
                let hostname = safeUrl;
                try { hostname = new URL(safeUrl).hostname; } catch (e) { }
                urlHtml = `<a href="${safeUrl}" target="_blank" class="text-xs text-gold hover:underline truncate block max-w-[150px]">${hostname}</a>`;
            }

            return `
            <div class="bg-darkgray rounded-xl p-5 border border-gray-800 hover:border-gold transition-colors group relative shadow-lg">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded bg-black flex items-center justify-center text-gold border border-gray-800 mr-3 text-lg">
                            ${entry.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-lg leading-tight">${entry.name}</h3>
                            ${urlHtml}
                        </div>
                    </div>
                    <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editEntry('${entry.id}')" class="w-8 h-8 rounded-full bg-gray-800 hover:bg-black text-gray-300 hover:text-gold flex items-center justify-center"><i class="fas fa-pen text-xs"></i></button>
                        <button onclick="initiateDeleteEntry('${entry.id}')" class="w-8 h-8 rounded-full bg-gray-800 hover:bg-red-900 text-gray-300 hover:text-red-500 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="bg-black p-2 rounded border border-gray-800 flex justify-between items-center">
                        <div class="flex items-center overflow-hidden"><i class="fas fa-user text-gray-600 text-xs w-5"></i><span class="text-sm text-gray-300 truncate ml-1">${entry.username}</span></div>
                        <button onclick="copyToClipboard('${entry.username}')" class="text-gray-500 hover:text-gold px-2"><i class="far fa-copy"></i></button>
                    </div>
                    <div class="bg-black p-2 rounded border border-gray-800 flex justify-between items-center">
                        <div class="flex items-center overflow-hidden"><i class="fas fa-key text-gray-600 text-xs w-5"></i><input type="password" value="${entry.password}" class="bg-transparent border-none text-sm text-gray-300 w-full focus:outline-none" readonly id="pass-display-${entry.id}"></div>
                        <div class="flex items-center">
                            <button onclick="toggleCardPassVisibility('${entry.id}')" class="text-gray-500 hover:text-white px-2"><i class="far fa-eye" id="eye-icon-${entry.id}"></i></button>
                            <button onclick="copyToClipboard('${entry.password}')" class="text-gray-500 hover:text-gold px-2"><i class="far fa-copy"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        document.getElementById('search-input').addEventListener('input', renderPasswords);

        // MODALS
        function openPasswordModal() {
            document.getElementById('password-form').reset();
            document.getElementById('entry-id').value = '';
            document.getElementById('modal-title').textContent = 'Neues Passwort erstellen';
            document.getElementById('entry-password').type = 'text';

            // FIX: Ensure username is empty for new entries
            document.getElementById('entry-username').value = '';

            checkStrength('');
            document.getElementById('password-modal').classList.remove('hidden');
        }

        function openFolderModal() { document.getElementById('folder-modal').classList.remove('hidden'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); if (modalId === 'delete-modal') deleteTarget = null; }

        function editEntry(id) {
            const entry = entriesData.find(e => e.id === id);
            if (!entry) return;
            document.getElementById('entry-id').value = entry.id;
            document.getElementById('entry-name').value = entry.name;
            document.getElementById('entry-folder').value = entry.folder;
            document.getElementById('entry-url').value = entry.url;
            document.getElementById('entry-username').value = entry.username;
            document.getElementById('entry-password').value = entry.password;
            document.getElementById('entry-password-confirm').value = entry.password;
            checkStrength(entry.password);
            document.getElementById('modal-title').textContent = 'Passwort bearbeiten';
            document.getElementById('password-modal').classList.remove('hidden');
        }

        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('entry-id').value;
            const name = document.getElementById('entry-name').value;
            const folder = document.getElementById('entry-folder').value;
            const url = document.getElementById('entry-url').value;
            const username = document.getElementById('entry-username').value;
            const pass = document.getElementById('entry-password').value;
            const passConfirm = document.getElementById('entry-password-confirm').value;

            if (pass !== passConfirm) { showToast('Passwörter stimmen nicht überein!', 'error'); return; }

            const entryData = { id: id || null, user: currentUser, name, folder, url, username, password: pass };
            const result = await apiRequest('entries', 'POST', entryData);

            if (result && result.success) {
                await loadApp();
                closeModal('password-modal');
                showToast('Passwort gespeichert');
            }
        });

        function initiateDeleteEntry(id) {
            deleteTarget = { type: 'entry', id: id };
            document.getElementById('delete-modal-text').textContent = "Eintrag löschen?";
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        async function confirmDelete() {
            if (!deleteTarget) { closeModal('delete-modal'); return; }
            let result;
            if (deleteTarget.type === 'folder') {
                result = await apiRequest('folders', 'DELETE', { username: currentUser, folderName: deleteTarget.id });
                if (result && result.success) {
                    if (currentFolder === deleteTarget.id) currentFolder = 'Alle';
                    await loadApp();
                    showToast('Ordner gelöscht');
                }
            } else if (deleteTarget.type === 'entry') {
                result = await apiRequest('entries', 'DELETE', { username: currentUser, id: deleteTarget.id });
                if (result && result.success) {
                    await loadApp();
                    showToast('Eintrag gelöscht');
                }
            }
            closeModal('delete-modal');
        }

        // UTILS
        const slider = document.getElementById('pass-length');
        const sliderVal = document.getElementById('slider-val');
        slider.oninput = function () { sliderVal.textContent = this.value; }

        function generatePassword() {
            const length = parseInt(slider.value);
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=";
            let retVal = "";
            for (let i = 0, n = charset.length; i < length; ++i) retVal += charset.charAt(Math.floor(Math.random() * n));
            document.getElementById('entry-password').value = retVal;
            document.getElementById('entry-password-confirm').value = retVal;
            checkStrength(retVal);
        }

        function checkStrength(password) {
            const meter = document.getElementById('strength-meter');
            const text = document.getElementById('strength-text');
            let strength = 0;
            if (password.length > 0) strength += 1;
            if (password.length > 8) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^A-Za-z0-9]/.test(password)) strength += 1;

            let color = 'bg-red-500';
            let status = 'Sehr Schwach';
            let width = '10%';
            switch (strength) {
                case 1: width = '20%'; break;
                case 2: width = '40%'; color = 'bg-orange-500'; status = 'Schwach'; break;
                case 3: width = '60%'; color = 'bg-yellow-500'; status = 'Mittel'; break;
                case 4: width = '80%'; color = 'bg-blue-500'; status = 'Gut'; break;
                case 5: width = '100%'; color = 'bg-green-500'; status = 'Sehr Stark'; break;
            }
            if (password.length === 0) { width = '0%'; status = 'Leer'; }
            meter.className = `h-full strength-bar ${color}`;
            meter.style.width = width;
            text.textContent = `Stärke: ${status}`;
        }

        function copyToClipboard(text) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => showToast('Kopiert!')).catch(() => showToast('Fehler beim Kopieren', 'error'));
        }

        function toggleCardPassVisibility(id) {
            const input = document.getElementById(`pass-display-${id}`);
            const icon = document.getElementById(`eye-icon-${id}`);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-message');
            msg.textContent = message;
            if (type === 'error') {
                toast.classList.remove('border-gold');
                toast.classList.add('border-red-600');
            } else {
                toast.classList.add('border-gold');
                toast.classList.remove('border-red-600');
            }
            toast.classList.remove('translate-x-full');
            setTimeout(() => { toast.classList.add('translate-x-full'); }, 3000);
        }
    </script>
</body>

</html>