<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoKe Passwortmanager</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23C49C48' rx='15' width='100' height='100'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='%23000'>üîê</text></svg>">
    <!-- Auth0 SPA JS SDK via CDN -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
    <!-- Tailwind CSS f√ºr schnelles, sauberes Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#000000',
                        darkgray: '#111111',
                        gold: '#C49C48',
                        goldhover: '#a37f36',
                        offwhite: '#e5e5e5'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #000000;
            color: #e5e5e5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #000000;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #C49C48;
        }

        .input-field {
            background-color: #111111;
            border: 1px solid #333;
            color: white;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #C49C48;
            box-shadow: 0 0 0 1px #C49C48;
        }

        .btn-gold {
            background-color: #C49C48;
            color: black;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-gold:hover {
            background-color: #a37f36;
            transform: translateY(-1px);
        }

        .sidebar-link {
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background-color: #111111;
            border-left-color: #C49C48;
            color: #C49C48;
        }

        .strength-bar {
            transition: width 0.3s ease-in-out, background-color 0.3s;
        }

        #loading-overlay {
            backdrop-filter: blur(2px);
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">

    <!-- TOAST -->
    <div id="toast"
        class="fixed top-5 right-5 bg-darkgray border-l-4 border-gold text-white px-6 py-4 rounded shadow-2xl transform translate-x-full transition-transform duration-300 z-50">
        <span id="toast-message">Nachricht</span>
    </div>

    <!-- LOADING -->
    <div id="loading-overlay"
        class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gold"></div>
    </div>

    <!-- ================= AUTH SCREEN (AUTH0 INTEGRATION) ================= -->
    <div id="auth-screen" class="fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-100">
        <div class="bg-darkgray p-8 rounded-xl shadow-2xl border border-gray-800 w-full max-w-md">

            <!-- Auth0 Loading State -->
            <div id="auth0-loading-state" class="text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gold mx-auto mb-4"></div>
                <p class="text-gray-400">Authentifizierung wird geladen...</p>
            </div>

            <!-- Auth0 Error State -->
            <div id="auth0-error-state" class="hidden text-center py-8">
                <div class="w-16 h-16 bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Authentifizierungsfehler</h3>
                <p id="auth0-error-message" class="text-gray-400 text-sm mb-4">Ein Fehler ist aufgetreten.</p>
                <button onclick="auth0Login()" class="btn-gold px-6 py-2 rounded">Erneut versuchen</button>
            </div>

            <!-- Auth0 Login State -->
            <div id="auth0-login-state" class="hidden">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gold tracking-wider mb-2">NoKe</h1>
                    <p class="text-gray-400 text-sm">Sicherer Passwortmanager mit Auth0</p>
                </div>

                <!-- Auth0 Login Features -->
                <div class="space-y-4 mb-8">
                    <div class="flex items-center gap-3 text-gray-400">
                        <i class="fas fa-shield-halved text-gold w-5"></i>
                        <span class="text-sm">Ende-zu-Ende Verschl√ºsselung</span>
                    </div>
                    <div class="flex items-center gap-3 text-gray-400">
                        <i class="fas fa-lock text-gold w-5"></i>
                        <span class="text-sm">Sichere Authentifizierung mit Auth0</span>
                    </div>
                    <div class="flex items-center gap-3 text-gray-400">
                        <i class="fas fa-cloud text-gold w-5"></i>
                        <span class="text-sm">Synchronisierung √ºber alle Ger√§te</span>
                    </div>
                </div>

                <button onclick="auth0Login()"
                    class="btn-gold w-full py-3 rounded flex items-center justify-center gap-2">
                    <i class="fas fa-sign-in-alt"></i>
                    Mit Auth0 anmelden
                </button>

                <p class="text-center text-xs text-gray-500 mt-6">
                    Gesichert durch <a href="https://auth0.com" target="_blank"
                        class="text-gold hover:underline">Auth0</a>
                </p>
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP INTERFACE ================= -->
    <div id="app-interface" class="flex h-full hidden">

        <!-- SIDEBAR -->
        <div class="w-64 bg-black border-r border-gray-800 flex flex-col flex-shrink-0">
            <div class="p-6 border-b border-gray-800">
                <h2 class="text-2xl font-bold text-gold">NoKe</h2>
            </div>

            <!-- User Profile Small (Auth0 Integration) -->
            <div class="p-4 flex items-center space-x-3 bg-darkgray mx-4 mt-4 rounded border border-gray-800">
                <img id="user-avatar"
                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23C49C48'/%3E%3Cpath d='M16 14.5c2.5 0 4.5-2 4.5-4.5s-2-4.5-4.5-4.5-4.5 2-4.5 4.5 2 4.5 4.5 4.5zm0 2.25c-3 0-9 1.5-9 4.5v1.13c0 .62.5 1.12 1.13 1.12h15.75c.62 0 1.13-.5 1.13-1.13v-1.12c0-3-6-4.5-9-4.5z' fill='%23000'/%3E%3C/svg%3E"
                    alt="User Avatar" class="w-8 h-8 rounded-full object-cover border border-gold"
                    onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'32\' height=\'32\' viewBox=\'0 0 32 32\'%3E%3Ccircle cx=\'16\' cy=\'16\' r=\'16\' fill=\'%23C49C48\'/%3E%3Cpath d=\'M16 14.5c2.5 0 4.5-2 4.5-4.5s-2-4.5-4.5-4.5-4.5 2-4.5 4.5 2 4.5 4.5 4.5zm0 2.25c-3 0-9 1.5-9 4.5v1.13c0 .62.5 1.12 1.13 1.12h15.75c.62 0 1.13-.5 1.13-1.13v-1.12c0-3-6-4.5-9-4.5z\' fill=\'%23000\'/%3E%3C/svg%3E'">
                <div class="overflow-hidden flex-1">
                    <p id="current-username-display" class="text-sm font-bold truncate">User</p>
                    <p id="current-email-display" class="text-xs text-gray-500 truncate hidden"></p>
                    <button onclick="auth0Logout()"
                        class="text-xs text-gray-500 hover:text-gold transition-colors">Abmelden</button>
                </div>
            </div>

            <!-- Folders Navigation -->
            <div class="flex-1 overflow-y-auto py-6 px-2 space-y-1">
                <p class="px-4 text-xs text-gray-500 uppercase font-semibold mb-2">Ordner</p>
                <div id="folder-list">
                    <!-- Folders will be injected here via JS -->
                </div>

                <button onclick="openFolderModal()"
                    class="w-full text-left px-4 py-2 text-sm text-gray-400 hover:text-gold transition-colors mt-4 flex items-center">
                    <i class="fas fa-plus mr-2"></i> Ordner erstellen
                </button>

                <!-- Navigation Links -->
                <div class="mt-6 pt-6 border-t border-gray-800">
                    <p class="px-4 text-xs text-gray-500 uppercase font-semibold mb-2">Men√º</p>
                    
                    <button onclick="showPage('passwords')" id="nav-passwords"
                        class="sidebar-link w-full text-left rounded px-4 py-2 text-sm text-gray-400 hover:text-gold transition-colors flex items-center active">
                        <i class="fas fa-key mr-3 w-4"></i> Passw√∂rter
                    </button>
                    
                    <button onclick="showPage('connections')" id="nav-connections"
                        class="sidebar-link w-full text-left rounded px-4 py-2 text-sm text-gray-400 hover:text-gold transition-colors flex items-center">
                        <i class="fas fa-plug mr-3 w-4"></i> Connections
                    </button>
                    
                    <button onclick="showPage('settings')" id="nav-settings"
                        class="sidebar-link w-full text-left rounded px-4 py-2 text-sm text-gray-400 hover:text-gold transition-colors flex items-center">
                        <i class="fas fa-cog mr-3 w-4"></i> Einstellungen
                    </button>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 flex flex-col bg-black min-w-0">

            <!-- ==================== PASSWORDS PAGE ==================== -->
            <div id="page-passwords" class="flex-1 flex flex-col">
                <!-- Top Bar: Search & Add -->
                <div class="p-6 border-b border-gray-800 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="relative w-full sm:w-96">
                        <i class="fas fa-search absolute left-3 top-3.5 text-gray-500"></i>
                        <input type="text" id="search-input" placeholder="Suchen nach Namen, Website..."
                            class="input-field w-full pl-10 pr-4 py-3 rounded-full text-sm bg-darkgray focus:bg-black">
                    </div>
                    <button onclick="openPasswordModal()"
                        class="btn-gold px-6 py-3 rounded-full shadow-lg flex items-center whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i> Neues Passwort
                    </button>
                </div>

                <!-- Password Grid -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="flex justify-between items-end mb-6">
                        <h2 id="current-folder-title" class="text-2xl font-bold text-white">Alle Passw√∂rter</h2>
                        <span id="entry-count" class="text-sm text-gold">0 Eintr√§ge</span>
                    </div>

                    <div id="password-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Password Cards will be injected here -->
                    </div>

                    <!-- Empty State -->
                    <div id="empty-state" class="hidden flex flex-col items-center justify-center h-64 text-gray-500">
                        <i class="fas fa-shield-alt text-6xl mb-4 text-gray-800"></i>
                        <p>Keine Passw√∂rter in diesem Ordner gefunden.</p>
                    </div>
                </div>
            </div>

            <!-- ==================== SETTINGS PAGE ==================== -->
            <div id="page-settings" class="flex-1 flex flex-col hidden">
                <div class="p-6 border-b border-gray-800">
                    <h1 class="text-2xl font-bold text-white">Einstellungen</h1>
                    <p class="text-gray-500 text-sm mt-1">Verwalten Sie Ihr Profil und Ihre Pr√§ferenzen</p>
                </div>

                <div class="flex-1 overflow-y-auto p-6">
                    <div class="max-w-2xl">
                        <!-- Profile Section -->
                        <div class="bg-darkgray border border-gray-800 rounded-xl p-6 mb-6">
                            <h2 class="text-lg font-bold text-gold mb-4 flex items-center">
                                <i class="fas fa-user mr-2"></i> Profil
                            </h2>
                            
                            <form id="settings-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Vorname</label>
                                        <input type="text" id="settings-firstname" class="input-field w-full p-2.5 rounded" placeholder="Max">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Nachname</label>
                                        <input type="text" id="settings-lastname" class="input-field w-full p-2.5 rounded" placeholder="Mustermann">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Anzeigename</label>
                                    <input type="text" id="settings-displayname" class="input-field w-full p-2.5 rounded" placeholder="Max Mustermann">
                                    <p class="text-xs text-gray-600 mt-1">Dieser Name wird in der Sidebar angezeigt</p>
                                </div>
                                
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">E-Mail</label>
                                    <input type="email" id="settings-email" class="input-field w-full p-2.5 rounded bg-gray-900" readonly>
                                    <p class="text-xs text-gray-600 mt-1">Die E-Mail wird von Auth0 verwaltet</p>
                                </div>

                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Unternehmen (optional)</label>
                                    <input type="text" id="settings-company" class="input-field w-full p-2.5 rounded" placeholder="Firma GmbH">
                                </div>

                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Telefon (optional)</label>
                                    <input type="tel" id="settings-phone" class="input-field w-full p-2.5 rounded" placeholder="+41 79 123 45 67">
                                </div>

                                <div class="pt-4 flex justify-end">
                                    <button type="submit" class="btn-gold px-6 py-2 rounded shadow flex items-center">
                                        <i class="fas fa-save mr-2"></i> Speichern
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Account Info -->
                        <div class="bg-darkgray border border-gray-800 rounded-xl p-6">
                            <h2 class="text-lg font-bold text-gold mb-4 flex items-center">
                                <i class="fas fa-info-circle mr-2"></i> Account-Informationen
                            </h2>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Auth0 ID</span>
                                    <span id="settings-auth0id" class="text-gray-300 font-mono text-xs">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Erstellt am</span>
                                    <span id="settings-created" class="text-gray-300">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Letzter Login</span>
                                    <span id="settings-lastlogin" class="text-gray-300">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== CONNECTIONS PAGE ==================== -->
            <div id="page-connections" class="flex-1 flex flex-col hidden">
                <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-white">Connections</h1>
                        <p class="text-gray-500 text-sm mt-1">API-Tokens f√ºr externe Anwendungen verwalten</p>
                    </div>
                    <button onclick="openTokenModal()" class="btn-gold px-4 py-2 rounded shadow flex items-center">
                        <i class="fas fa-plus mr-2"></i> Neuer Token
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Tokens List -->
                    <div id="tokens-list" class="space-y-4">
                        <!-- Tokens will be injected here -->
                    </div>

                    <!-- Empty State -->
                    <div id="tokens-empty" class="flex flex-col items-center justify-center h-64 text-gray-500">
                        <i class="fas fa-plug text-6xl mb-4 text-gray-800"></i>
                        <p class="mb-4">Keine API-Tokens vorhanden</p>
                        <button onclick="openTokenModal()" class="btn-gold px-4 py-2 rounded text-sm">
                            <i class="fas fa-plus mr-2"></i> Ersten Token erstellen
                        </button>
                    </div>

                    <!-- API Documentation -->
                    <div class="mt-8 bg-darkgray border border-gray-800 rounded-xl p-6">
                        <h2 class="text-lg font-bold text-gold mb-4 flex items-center">
                            <i class="fas fa-book mr-2"></i> API-Dokumentation
                        </h2>
                        <p class="text-gray-400 text-sm mb-4">
                            Verwenden Sie die API-Tokens, um von externen Anwendungen (z.B. Browser-Plugin) auf Ihre Passw√∂rter zuzugreifen.
                        </p>
                        <div class="bg-black rounded p-4 font-mono text-sm">
                            <p class="text-gray-500 mb-2"># Beispiel API-Aufruf</p>
                            <p class="text-green-400">GET /api/entries</p>
                            <p class="text-gray-400">Authorization: Bearer <span class="text-gold">&lt;your-token&gt;</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODAL: CREATE TOKEN ================= -->
    <div id="token-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-90 flex items-center justify-center px-4">
        <div class="bg-darkgray border border-gold rounded-xl w-full max-w-md relative">
            <button onclick="closeModal('token-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>

            <div class="p-6">
                <h3 class="text-xl font-bold text-gold mb-6">Neuen API-Token erstellen</h3>

                <form id="token-form" class="space-y-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Token-Name</label>
                        <input type="text" id="token-name" class="input-field w-full p-2.5 rounded" 
                            placeholder="z.B. Chrome Browser Plugin" required>
                        <p class="text-xs text-gray-600 mt-1">Geben Sie einen beschreibenden Namen f√ºr diesen Token</p>
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Berechtigungen</label>
                        <div class="space-y-2">
                            <label class="flex items-center text-sm text-gray-300">
                                <input type="checkbox" id="token-perm-read" checked class="mr-2 accent-gold"> 
                                <i class="fas fa-eye mr-2 text-green-500 w-4"></i> Passw√∂rter lesen
                            </label>
                            <label class="flex items-center text-sm text-gray-300">
                                <input type="checkbox" id="token-perm-write" class="mr-2 accent-gold"> 
                                <i class="fas fa-edit mr-2 text-yellow-500 w-4"></i> Passw√∂rter erstellen/bearbeiten
                            </label>
                            <label class="flex items-center text-sm text-gray-300">
                                <input type="checkbox" id="token-perm-delete" class="mr-2 accent-gold"> 
                                <i class="fas fa-trash mr-2 text-red-500 w-4"></i> Passw√∂rter l√∂schen
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">G√ºltigkeitsdauer</label>
                        <select id="token-expiry" class="input-field w-full p-2.5 rounded cursor-pointer">
                            <option value="30">30 Tage</option>
                            <option value="90">90 Tage</option>
                            <option value="365" selected>1 Jahr</option>
                            <option value="0">Nie ablaufen</option>
                        </select>
                    </div>

                    <div class="pt-4 flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('token-modal')" class="px-4 py-2 text-gray-400 hover:text-white">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn-gold px-6 py-2 rounded shadow">
                            Token erstellen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ================= MODAL: SHOW GENERATED TOKEN ================= -->
    <div id="token-display-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-90 flex items-center justify-center px-4">
        <div class="bg-darkgray border border-gold rounded-xl w-full max-w-lg relative">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-green-500 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Token erfolgreich erstellt!</h3>
                    <p class="text-gray-400 text-sm mt-2">
                        Kopieren Sie den Token jetzt. Er wird nur einmal angezeigt!
                    </p>
                </div>

                <div class="bg-black rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <code id="generated-token" class="text-gold font-mono text-sm break-all flex-1 mr-4">
                            <!-- Token will be inserted here -->
                        </code>
                        <button onclick="copyGeneratedToken()" class="btn-gold px-3 py-2 rounded text-sm flex-shrink-0">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-red-900/20 border border-red-800 rounded-lg p-4 mb-6">
                    <p class="text-red-400 text-sm flex items-start">
                        <i class="fas fa-exclamation-triangle mr-2 mt-0.5"></i>
                        <span>Dieser Token wird nur einmal angezeigt. Speichern Sie ihn sicher ab!</span>
                    </p>
                </div>

                <div class="flex justify-end">
                    <button onclick="closeModal('token-display-modal')" class="btn-gold px-6 py-2 rounded">
                        Verstanden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: DELETE CONFIRMATION -->
    <div id="delete-modal"
        class="fixed inset-0 z-50 hidden bg-black bg-opacity-90 flex items-center justify-center px-4">
        <div class="bg-darkgray border border-red-800 rounded-xl p-6 w-full max-w-sm relative shadow-2xl">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-black rounded-full flex items-center justify-center mx-auto mb-4 border border-red-900">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Bist du sicher?</h3>
                <p id="delete-modal-text" class="text-gray-400 text-sm">M√∂chtest du dieses Element wirklich l√∂schen?</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeModal('delete-modal')"
                    class="flex-1 py-3 rounded bg-gray-800 text-white hover:bg-gray-700 transition-colors">Abbrechen</button>
                <button onclick="confirmDelete()"
                    class="flex-1 py-3 rounded bg-red-700 text-white hover:bg-red-600 transition-colors font-bold">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CREATE/EDIT PASSWORD -->
    <div id="password-modal"
        class="fixed inset-0 z-50 hidden bg-black bg-opacity-90 overflow-y-auto h-full w-full flex items-center justify-center px-4">
        <div class="bg-darkgray border border-gold rounded-xl shadow-2xl w-full max-w-lg relative">

            <button onclick="closeModal('password-modal')"
                class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="p-6">
                <h3 id="modal-title" class="text-xl font-bold text-gold mb-6">Neues Passwort erstellen</h3>

                <form id="password-form" class="space-y-4">
                    <input type="hidden" id="entry-id"> <!-- Hidden ID for editing -->

                    <!-- Row 1 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Name (z.B. Google)</label>
                            <input type="text" id="entry-name" class="input-field w-full p-2.5 rounded" required>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Ordner</label>
                            <select id="entry-folder" class="input-field w-full p-2.5 rounded cursor-pointer">
                                <!-- Folder Options injected via JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Website Link (URL)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-500"><i class="fas fa-link"></i></span>
                            <input type="url" id="entry-url" class="input-field w-full pl-9 p-2.5 rounded"
                                placeholder="https://...">
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Benutzername / E-Mail</label>
                        <input type="text" id="entry-username" class="input-field w-full p-2.5 rounded">
                    </div>

                    <!-- Row 4: Password & Generator -->
                    <div class="bg-black p-4 rounded border border-gray-800 mt-2">
                        <label class="block text-xs text-gold mb-2">PASSWORT</label>

                        <div class="flex space-x-2 mb-3">
                            <input type="text" id="entry-password"
                                class="input-field flex-1 p-2.5 rounded font-mono text-sm"
                                placeholder="Passwort eingeben oder generieren" required
                                oninput="checkStrength(this.value)">
                            <button type="button" onclick="toggleVisibility('entry-password')"
                                class="bg-gray-800 text-white px-3 rounded hover:bg-gray-700"><i
                                    class="fas fa-eye"></i></button>
                        </div>

                        <!-- Generator Controls -->
                        <div class="mb-3">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>L√§nge: <span id="slider-val" class="text-gold">12</span></span>
                                <button type="button" onclick="generatePassword()" class="text-gold hover:underline">
                                    <i class="fas fa-random mr-1"></i> Generieren
                                </button>
                            </div>
                            <input type="range" id="pass-length" min="8" max="32" value="12"
                                class="w-full accent-gold h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Strength Meter -->
                        <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden">
                            <div id="strength-meter" class="h-full bg-red-500 w-0 strength-bar"></div>
                        </div>
                        <p id="strength-text" class="text-xs text-right mt-1 text-gray-500">St√§rke: Leer</p>

                        <!-- Confirm Password (Only visual validation logic in JS) -->
                        <div class="mt-3 pt-3 border-t border-gray-800">
                            <label class="block text-xs text-gray-400 mb-1">Passwort best√§tigen</label>
                            <input type="password" id="entry-password-confirm"
                                class="input-field w-full p-2.5 rounded text-sm">
                        </div>
                    </div>

                    <!-- Notes Field -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Notizen (optional)</label>
                        <textarea id="entry-notes" class="input-field w-full p-2.5 rounded" rows="2" placeholder="Zus√§tzliche Notizen..."></textarea>
                    </div>

                    <div class="pt-4 flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('password-modal')"
                            class="px-4 py-2 text-gray-400 hover:text-white">Abbrechen</button>
                        <button type="submit" class="btn-gold px-6 py-2 rounded shadow">Speichern</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: CREATE FOLDER -->
    <div id="folder-modal"
        class="fixed inset-0 z-50 hidden bg-black bg-opacity-90 flex items-center justify-center px-4">
        <div class="bg-darkgray border border-gold rounded-xl p-6 w-full max-w-sm relative">
            <button onclick="closeModal('folder-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-lg font-bold text-gold mb-4">Neuen Ordner erstellen</h3>
            <form onsubmit="createFolder(event)">
                <input type="text" id="new-folder-name" class="input-field w-full p-3 rounded mb-4"
                    placeholder="Ordnername (z.B. Arbeit)" required>
                <button type="submit" class="btn-gold w-full py-2 rounded">Erstellen</button>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==========================================
        // AUTH0 CONFIGURATION
        // ==========================================

        // HIER AUTH0 KONFIGURATION EINF√úGEN
        // Gehe zu https://manage.auth0.com/dashboard/ und erstelle eine SPA-Anwendung
        const AUTH0_CONFIG = {
            domain: 'noke.eu.auth0.com',  // z.B. 'dev-xxxxx.us.auth0.com'
            clientId: 'JggU0AdC5XSjFdcDBx87Sv0MjOlsEqsJ'        // z.B. 'abc123def456...'
        };

        // Auth0 Client Instance
        let auth0Client = null;
        let auth0User = null;

        // ==========================================
        // AZURE CONFIGURATION
        const AZURE_FUNCTION_BASE_URL = "/api";

        // State
        let currentUser = null;
        let currentFolder = 'Alle';
        let deleteTarget = null;
        let foldersData = [];
        let entriesData = [];

        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const appInterface = document.getElementById('app-interface');
        const passwordGrid = document.getElementById('password-grid');
        const folderList = document.getElementById('folder-list');
        const loadingOverlay = document.getElementById('loading-overlay');

        // Auth0 DOM Elements
        const auth0LoadingState = document.getElementById('auth0-loading-state');
        const auth0ErrorState = document.getElementById('auth0-error-state');
        const auth0LoginState = document.getElementById('auth0-login-state');
        const auth0ErrorMessage = document.getElementById('auth0-error-message');

        // ==========================================
        // AUTH0 INTEGRATION
        // ==========================================

        /**
         * Initialize Auth0 Client
         */
        async function initAuth0() {
            try {
                // Validate configuration
                if (!AUTH0_CONFIG.domain || AUTH0_CONFIG.domain === 'YOUR_AUTH0_DOMAIN.auth0.com') {
                    throw new Error('Bitte Auth0 Domain konfigurieren (AUTH0_CONFIG.domain)');
                }
                if (!AUTH0_CONFIG.clientId || AUTH0_CONFIG.clientId === 'YOUR_AUTH0_CLIENT_ID') {
                    throw new Error('Bitte Auth0 Client ID konfigurieren (AUTH0_CONFIG.clientId)');
                }

                // Check for plugin authorization request BEFORE handling Auth0 callback
                checkPluginAuthRequest();

                // Create Auth0 client
                auth0Client = await window.auth0.createAuth0Client({
                    domain: AUTH0_CONFIG.domain,
                    clientId: AUTH0_CONFIG.clientId,
                    authorizationParams: {
                        redirect_uri: window.location.origin + window.location.pathname
                    },
                    cacheLocation: 'localstorage'
                });

                // Handle redirect callback
                if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
                    await auth0Client.handleRedirectCallback();
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                // Check authentication state
                const isAuthenticated = await auth0Client.isAuthenticated();

                if (isAuthenticated) {
                    auth0User = await auth0Client.getUser();
                    currentUser = auth0User.email || auth0User.name || auth0User.sub;
                    
                    // Ensure user exists in database (create if not)
                    await ensureUserInDatabase();
                    
                    await showMainApp();
                } else {
                    // If plugin auth request, store in sessionStorage and redirect to login
                    if (pluginAuthState && pluginAuthState.active) {
                        sessionStorage.setItem('pluginAuthState', JSON.stringify(pluginAuthState));
                    }
                    showAuth0LoginState();
                }

            } catch (error) {
                console.error('Auth0 Initialization Error:', error);
                showAuth0ErrorState(error.message);
            }
        }

        /**
         * Ensure Auth0 user exists in database
         * Creates a new user record if they don't exist yet
         */
        async function ensureUserInDatabase() {
            try {
                const result = await apiRequest('auth', 'POST', {
                    action: 'ensure-user',
                    username: currentUser,
                    email: auth0User.email,
                    name: auth0User.name,
                    picture: auth0User.picture,
                    auth0Id: auth0User.sub
                });
                
                if (result && result.success) {
                    console.log('User synced with database:', result.message);
                } else if (result) {
                    console.warn('User sync warning:', result.message);
                }
            } catch (error) {
                console.error('Error ensuring user in database:', error);
                // Don't block login if this fails - user can still use the app
            }
        }

        /**
         * Auth0 Login
         */
        async function auth0Login() {
            try {
                await auth0Client.loginWithRedirect();
            } catch (error) {
                console.error('Auth0 Login Error:', error);
                showAuth0ErrorState('Anmeldung fehlgeschlagen: ' + error.message);
            }
        }

        /**
         * Auth0 Logout
         */
        async function auth0Logout() {
            try {
                await auth0Client.logout({
                    logoutParams: {
                        returnTo: window.location.origin + window.location.pathname
                    }
                });
            } catch (error) {
                console.error('Auth0 Logout Error:', error);
                showToast('Abmeldung fehlgeschlagen', 'error');
            }
        }

        /**
         * Show Auth0 Loading State
         */
        function showAuth0LoadingState() {
            auth0LoadingState.classList.remove('hidden');
            auth0ErrorState.classList.add('hidden');
            auth0LoginState.classList.add('hidden');
        }

        /**
         * Show Auth0 Error State
         */
        function showAuth0ErrorState(message) {
            auth0LoadingState.classList.add('hidden');
            auth0ErrorState.classList.remove('hidden');
            auth0LoginState.classList.add('hidden');
            auth0ErrorMessage.textContent = message;
        }

        /**
         * Show Auth0 Login State
         */
        function showAuth0LoginState() {
            auth0LoadingState.classList.add('hidden');
            auth0ErrorState.classList.add('hidden');
            auth0LoginState.classList.remove('hidden');
        }

        /**
         * Plugin Authorization State
         */
        let pluginAuthState = null;

        /**
         * Check if this is a plugin authorization request
         */
        function checkPluginAuthRequest() {
            // First check URL parameters (initial request from plugin)
            const urlParams = new URLSearchParams(window.location.search);
            const pluginAuth = urlParams.get('plugin_auth');
            const pluginName = urlParams.get('plugin_name');
            const redirectUri = urlParams.get('redirect_uri');
            const state = urlParams.get('plugin_state');

            if (pluginAuth === 'true') {
                pluginAuthState = {
                    active: true,
                    pluginName: pluginName || 'Browser Plugin',
                    redirectUri: redirectUri,
                    state: state
                };
                // Store in sessionStorage in case Auth0 redirects
                sessionStorage.setItem('pluginAuthState', JSON.stringify(pluginAuthState));
                // Clean URL but keep state in memory
                window.history.replaceState({}, document.title, window.location.pathname);
                return true;
            }

            // Check sessionStorage (after Auth0 redirect)
            const storedState = sessionStorage.getItem('pluginAuthState');
            if (storedState) {
                try {
                    pluginAuthState = JSON.parse(storedState);
                    return true;
                } catch (e) {
                    console.error('Error parsing plugin auth state:', e);
                }
            }

            return false;
        }

        /**
         * Open Plugin Authorization Modal
         */
        function openPluginAuthModal() {
            // Pre-fill the token name with plugin name
            document.getElementById('token-name').value = pluginAuthState.pluginName || 'Browser Plugin';
            document.getElementById('token-perm-read').checked = true;
            document.getElementById('token-perm-write').checked = false;
            document.getElementById('token-perm-delete').checked = false;
            
            // Show plugin auth banner
            const modal = document.getElementById('token-modal');
            modal.classList.remove('hidden');
            
            // Add plugin auth info banner if not already added
            if (!document.getElementById('plugin-auth-banner')) {
                const form = document.getElementById('token-form');
                const banner = document.createElement('div');
                banner.id = 'plugin-auth-banner';
                banner.className = 'bg-blue-900/30 border border-blue-700 rounded-lg p-4 mb-4';
                banner.innerHTML = `
                    <div class="flex items-start gap-3">
                        <i class="fas fa-puzzle-piece text-blue-400 text-xl mt-0.5"></i>
                        <div>
                            <p class="text-blue-300 font-medium">Plugin-Autorisierung</p>
                            <p class="text-blue-400/80 text-sm mt-1">
                                Das Plugin <strong>${escapeHtml(pluginAuthState.pluginName)}</strong> m√∂chte Zugriff auf Ihre Passw√∂rter.
                                Erstellen Sie einen Token, der automatisch an das Plugin √ºbertragen wird.
                            </p>
                        </div>
                    </div>
                `;
                form.insertBefore(banner, form.firstChild);
            }
        }

        /**
         * Clear Plugin Auth State
         */
        function clearPluginAuthState() {
            pluginAuthState = null;
            sessionStorage.removeItem('pluginAuthState');
            const banner = document.getElementById('plugin-auth-banner');
            if (banner) banner.remove();
        }

        /**
         * Send Token to Plugin (via postMessage or redirect)
         */
        function sendTokenToPlugin(token) {
            if (!pluginAuthState || !pluginAuthState.active) return;

            // Method 1: postMessage (if opener exists - popup window)
            if (window.opener) {
                window.opener.postMessage({
                    type: 'NOKE_TOKEN_RESPONSE',
                    success: true,
                    token: token,
                    state: pluginAuthState.state
                }, '*');
                
                showToast('Token an Plugin √ºbertragen!');
                setTimeout(() => window.close(), 2000);
                clearPluginAuthState();
                return;
            }

            // Method 2: Redirect URI (for extensions that can't use popup)
            if (pluginAuthState.redirectUri) {
                const redirectUrl = new URL(pluginAuthState.redirectUri);
                redirectUrl.searchParams.set('token', token);
                if (pluginAuthState.state) {
                    redirectUrl.searchParams.set('state', pluginAuthState.state);
                }
                
                showToast('Weiterleitung zum Plugin...');
                setTimeout(() => {
                    window.location.href = redirectUrl.toString();
                }, 1000);
                clearPluginAuthState();
                return;
            }

            // Method 3: Display token for manual copy (fallback)
            clearPluginAuthState();
        }

        /**
         * Show Main App after successful authentication
         */
        async function showMainApp() {
            // Update user display
            const usernameDisplay = document.getElementById('current-username-display');
            const emailDisplay = document.getElementById('current-email-display');
            const userAvatar = document.getElementById('user-avatar');

            if (auth0User) {
                usernameDisplay.textContent = auth0User.name || auth0User.email || 'User';

                if (auth0User.email) {
                    emailDisplay.textContent = auth0User.email;
                    emailDisplay.classList.remove('hidden');
                }

                if (auth0User.picture) {
                    userAvatar.src = auth0User.picture;
                }
            }

            // Hide auth screen and show app
            authScreen.classList.add('hidden');
            appInterface.classList.remove('hidden');

            // Load initial data
            await loadFolders();
            await loadEntries();
            await loadUserSettings();
            await loadTokens();

            // Check if this is a plugin authorization request
            if (pluginAuthState && pluginAuthState.active) {
                // Redirect to connections page and open token modal
                showPage('connections');
                
                // Show plugin authorization modal instead of regular modal
                setTimeout(() => {
                    openPluginAuthModal();
                }, 500);
            }
        }

        // ==========================================
        // PAGE NAVIGATION
        // ==========================================

        let currentPage = 'passwords';

        function showPage(pageName) {
            // Hide all pages
            document.getElementById('page-passwords').classList.add('hidden');
            document.getElementById('page-settings').classList.add('hidden');
            document.getElementById('page-connections').classList.add('hidden');

            // Remove active from all nav items
            document.getElementById('nav-passwords').classList.remove('active');
            document.getElementById('nav-settings').classList.remove('active');
            document.getElementById('nav-connections').classList.remove('active');

            // Show selected page
            document.getElementById(`page-${pageName}`).classList.remove('hidden');
            document.getElementById(`nav-${pageName}`).classList.add('active');

            currentPage = pageName;

            // Load page-specific data
            if (pageName === 'settings') {
                loadUserSettings();
            } else if (pageName === 'connections') {
                loadTokens();
            }
        }

        // ==========================================
        // SETTINGS FUNCTIONS
        // ==========================================

        let userSettings = {};

        async function loadUserSettings() {
            try {
                const result = await apiRequest(`auth`, 'POST', {
                    action: 'get-profile',
                    username: currentUser
                });

                if (result && result.success && result.profile) {
                    userSettings = result.profile;
                    
                    // Fill form fields
                    document.getElementById('settings-firstname').value = userSettings.firstName || '';
                    document.getElementById('settings-lastname').value = userSettings.lastName || '';
                    document.getElementById('settings-displayname').value = userSettings.displayName || userSettings.name || '';
                    document.getElementById('settings-email').value = userSettings.email || currentUser;
                    document.getElementById('settings-company').value = userSettings.company || '';
                    document.getElementById('settings-phone').value = userSettings.phone || '';
                    
                    // Account info
                    document.getElementById('settings-auth0id').textContent = userSettings.auth0Id || '-';
                    document.getElementById('settings-created').textContent = userSettings.createdAt ? new Date(userSettings.createdAt).toLocaleDateString('de-DE') : '-';
                    document.getElementById('settings-lastlogin').textContent = userSettings.lastLogin ? new Date(userSettings.lastLogin).toLocaleDateString('de-DE') : '-';

                    // Update sidebar display name
                    updateSidebarDisplayName();
                }
            } catch (error) {
                console.error('Error loading user settings:', error);
            }
        }

        async function saveUserSettings(e) {
            e.preventDefault();
            
            const settings = {
                firstName: document.getElementById('settings-firstname').value,
                lastName: document.getElementById('settings-lastname').value,
                displayName: document.getElementById('settings-displayname').value,
                company: document.getElementById('settings-company').value,
                phone: document.getElementById('settings-phone').value
            };

            try {
                const result = await apiRequest('auth', 'POST', {
                    action: 'update-profile',
                    username: currentUser,
                    ...settings
                });

                if (result && result.success) {
                    userSettings = { ...userSettings, ...settings };
                    updateSidebarDisplayName();
                    showToast('Einstellungen gespeichert');
                } else {
                    showToast(result?.message || 'Fehler beim Speichern', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        function updateSidebarDisplayName() {
            const displayName = userSettings.displayName || userSettings.name || auth0User?.name || currentUser;
            document.getElementById('current-username-display').textContent = displayName;
        }

        // ==========================================
        // TOKEN/CONNECTIONS FUNCTIONS
        // ==========================================

        let tokensData = [];

        async function loadTokens() {
            try {
                const result = await apiRequest('auth', 'POST', {
                    action: 'list-tokens',
                    username: currentUser
                });

                if (result && result.success) {
                    tokensData = result.tokens || [];
                    renderTokens();
                }
            } catch (error) {
                console.error('Error loading tokens:', error);
            }
        }

        function renderTokens() {
            const tokensList = document.getElementById('tokens-list');
            const tokensEmpty = document.getElementById('tokens-empty');

            if (tokensData.length === 0) {
                tokensList.innerHTML = '';
                tokensEmpty.classList.remove('hidden');
                return;
            }

            tokensEmpty.classList.add('hidden');
            tokensList.innerHTML = tokensData.map(token => `
                <div class="bg-darkgray border border-gray-800 rounded-xl p-5 hover:border-gold transition-all">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gold/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-key text-gold"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white">${token.name}</h3>
                                <p class="text-xs text-gray-500">Erstellt: ${new Date(token.createdAt).toLocaleDateString('de-DE')}</p>
                            </div>
                        </div>
                        <button onclick="revokeToken('${token.id}')" class="text-gray-500 hover:text-red-500 p-2" title="Token widerrufen">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${token.permissions?.read ? '<span class="bg-green-900/30 text-green-400 text-xs px-2 py-1 rounded">Lesen</span>' : ''}
                        ${token.permissions?.write ? '<span class="bg-yellow-900/30 text-yellow-400 text-xs px-2 py-1 rounded">Schreiben</span>' : ''}
                        ${token.permissions?.delete ? '<span class="bg-red-900/30 text-red-400 text-xs px-2 py-1 rounded">L√∂schen</span>' : ''}
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>Token: ${token.tokenPreview || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</span>
                        <span>${token.expiresAt ? 'L√§uft ab: ' + new Date(token.expiresAt).toLocaleDateString('de-DE') : 'Kein Ablaufdatum'}</span>
                    </div>
                </div>
            `).join('');
        }

        function openTokenModal() {
            document.getElementById('token-form').reset();
            document.getElementById('token-modal').classList.remove('hidden');
        }

        async function createToken(e) {
            e.preventDefault();

            const tokenData = {
                name: document.getElementById('token-name').value,
                permissions: {
                    read: document.getElementById('token-perm-read').checked,
                    write: document.getElementById('token-perm-write').checked,
                    delete: document.getElementById('token-perm-delete').checked
                },
                expiryDays: parseInt(document.getElementById('token-expiry').value)
            };

            try {
                const result = await apiRequest('auth', 'POST', {
                    action: 'create-token',
                    username: currentUser,
                    ...tokenData
                });

                if (result && result.success && result.token) {
                    closeModal('token-modal');
                    
                    // Check if this is a plugin authorization
                    if (pluginAuthState && pluginAuthState.active) {
                        // Send token to plugin
                        sendTokenToPlugin(result.token);
                        
                        // Show success modal with plugin-specific message
                        document.getElementById('generated-token').textContent = result.token;
                        const displayModal = document.getElementById('token-display-modal');
                        displayModal.classList.remove('hidden');
                        
                        // Update modal message for plugin auth
                        const successIcon = displayModal.querySelector('.fa-check');
                        if (successIcon) {
                            successIcon.classList.remove('fa-check');
                            successIcon.classList.add('fa-puzzle-piece');
                        }
                    } else {
                        // Show the generated token (normal flow)
                        document.getElementById('generated-token').textContent = result.token;
                        document.getElementById('token-display-modal').classList.remove('hidden');
                    }
                    
                    // Reload tokens list
                    await loadTokens();
                } else {
                    showToast(result?.message || 'Fehler beim Erstellen', 'error');
                }
            } catch (error) {
                console.error('Error creating token:', error);
                showToast('Fehler beim Erstellen', 'error');
            }
        }

        function copyGeneratedToken() {
            const token = document.getElementById('generated-token').textContent;
            navigator.clipboard.writeText(token).then(() => {
                showToast('Token kopiert!');
            }).catch(() => {
                showToast('Fehler beim Kopieren', 'error');
            });
        }

        async function revokeToken(tokenId) {
            if (!confirm('M√∂chten Sie diesen Token wirklich widerrufen? Alle Anwendungen, die diesen Token verwenden, verlieren den Zugriff.')) {
                return;
            }

            try {
                const result = await apiRequest('auth', 'POST', {
                    action: 'revoke-token',
                    username: currentUser,
                    tokenId: tokenId
                });

                if (result && result.success) {
                    showToast('Token widerrufen');
                    await loadTokens();
                } else {
                    showToast(result?.message || 'Fehler beim Widerrufen', 'error');
                }
            } catch (error) {
                console.error('Error revoking token:', error);
                showToast('Fehler beim Widerrufen', 'error');
            }
        }

        // Event Listeners for new forms
        function setupNewEventListeners() {
            const settingsForm = document.getElementById('settings-form');
            const tokenForm = document.getElementById('token-form');
            
            if (settingsForm) settingsForm.addEventListener('submit', saveUserSettings);
            if (tokenForm) tokenForm.addEventListener('submit', createToken);
        }

        // Initialize new event listeners
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupNewEventListeners);
        } else {
            setupNewEventListeners();
        }

        /**
         * Get Auth0 Access Token for API calls
         */
        async function getAuth0Token(audience, scope) {
            if (!auth0Client) return null;
            try {
                const token = await auth0Client.getTokenSilently({
                    authorizationParams: {
                        audience: audience,
                        scope: scope || 'openid profile email'
                    }
                });
                return token;
            } catch (error) {
                console.error('Error getting access token:', error);
                return null;
            }
        }

        // Initialize Auth0 on page load
        document.addEventListener('DOMContentLoaded', () => {
            initAuth0();
        });

        // API HELPER
        async function apiRequest(endpoint, method = 'GET', body = null) {
            if (!AZURE_FUNCTION_BASE_URL) {
                showToast("Bitte Azure URL im Code konfigurieren!", "error");
                return null;
            }

            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');

            try {
                const headers = { 'Content-Type': 'application/json' };
                const config = { method, headers };
                if (body) config.body = JSON.stringify(body);

                const response = await fetch(`${AZURE_FUNCTION_BASE_URL}/${endpoint}`, config);
                const data = await response.json().catch(() => ({}));

                if (!response.ok) {
                    let errorMessage = data.message || `HTTP Fehler: ${response.status}`;
                    if (data.errorDetails) errorMessage += ` (Details: ${data.errorDetails})`;
                    throw new Error(errorMessage);
                }
                return data;

            } catch (error) {
                console.error("API Error:", error);
                showToast(error.message || "Verbindungsfehler zu Azure", "error");
                return null;
            } finally {
                loadingOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('flex');
            }
        }

        // ==========================================
        // LEGACY AUTH SYSTEM (REPLACED BY AUTH0)
        // ==========================================
        // The following functions are kept for compatibility but Auth0 is now the primary auth method

        function toggleAuth(mode) {
            // Legacy function - Auth0 handles authentication now
            console.log('toggleAuth called but Auth0 is now handling authentication');
        }

        // Legacy logout function - now calls Auth0 logout
        function logout() {
            auth0Logout();
        }

        // APP LOGIC
        async function loadApp() {
            // This is called by Auth0 after successful authentication
            await loadFolders();
            await loadEntries();
        }

        async function loadAppData() {
            // Hole alle Daten f√ºr den User auf einmal
            // Erwartet Antwort: { folders: [...], entries: [...] }
            const data = await apiRequest(`data?username=${encodeURIComponent(currentUser)}`, 'GET');
            if (data) {
                foldersData = data.folders || [];
                entriesData = data.entries || [];
                renderFolders();
                renderPasswords();
            }
        }

        // FOLDERS
        function renderFolders() {
            let html = `
                <div class="sidebar-link rounded px-4 py-2 cursor-pointer flex items-center justify-between ${currentFolder === 'Alle' ? 'active' : ''}" onclick="switchFolder('Alle')">
                    <span class="text-sm font-medium"><i class="fas fa-layer-group mr-3 w-4"></i> Alle</span>
                </div>
            `;
            foldersData.forEach(folder => {
                const fName = typeof folder === 'string' ? folder : folder.name;
                html += `
                    <div class="sidebar-link rounded px-4 py-2 cursor-pointer flex items-center justify-between ${currentFolder === fName ? 'active' : ''}" onclick="switchFolder('${fName}')">
                        <span class="text-sm font-medium"><i class="far fa-folder mr-3 w-4"></i> ${fName}</span>
                        <button onclick="initiateDeleteFolder('${fName}', event)" class="text-xs text-gray-600 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
            folderList.innerHTML = html;

            const select = document.getElementById('entry-folder');
            select.innerHTML = '<option value="Alle">Alle</option>';
            foldersData.forEach(f => {
                const fName = typeof f === 'string' ? f : f.name;
                select.innerHTML += `<option value="${fName}">${fName}</option>`;
            });
        }

        function switchFolder(folderName) {
            currentFolder = folderName;
            renderFolders();
            renderPasswords();
        }

        async function createFolder(e) {
            e.preventDefault();
            const name = document.getElementById('new-folder-name').value;
            if (!name) return;
            const result = await apiRequest('folders', 'POST', { username: currentUser, folderName: name });
            if (result && result.success) {
                foldersData.push(name);
                closeModal('folder-modal');
                document.getElementById('new-folder-name').value = '';
                renderFolders();
                showToast(`Ordner "${name}" erstellt`);
            }
        }

        function initiateDeleteFolder(folderName, event) {
            event.stopPropagation();
            deleteTarget = { type: 'folder', id: folderName };
            document.getElementById('delete-modal-text').textContent = `Den Ordner "${folderName}" und alle Inhalte wirklich l√∂schen?`;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        // ==========================================
        // LOAD DATA FUNCTIONS
        // ==========================================

        async function loadFolders() {
            // Use the /data endpoint which returns both folders and entries
            const result = await apiRequest(`data?username=${encodeURIComponent(currentUser)}`, 'GET');
            if (result) {
                foldersData = result.folders || [];
                entriesData = result.entries || [];
                renderFolders();
                renderPasswords();
            }
        }

        async function loadEntries() {
            // Reload all data from server to get fresh entries
            const result = await apiRequest(`data?username=${encodeURIComponent(currentUser)}`, 'GET');
            if (result) {
                foldersData = result.folders || [];
                entriesData = result.entries || [];
                renderFolders();
                renderPasswords();
            }
        }

        // Alias for compatibility
        async function loadData() {
            await loadFolders();
        }

        // ==========================================
        // MODAL FUNCTIONS
        // ==========================================

        function openFolderModal() {
            document.getElementById('folder-modal').classList.remove('hidden');
        }

        function openPasswordModal(entryId = null) {
            const modal = document.getElementById('password-modal');
            const form = document.getElementById('password-form');
            const title = document.getElementById('modal-title');
            
            form.reset();
            document.getElementById('entry-id').value = '';
            
            if (entryId) {
                const entry = entriesData.find(e => e.id === entryId);
                if (entry) {
                    title.textContent = 'Passwort bearbeiten';
                    document.getElementById('entry-id').value = entry.id;
                    document.getElementById('entry-name').value = entry.name || '';
                    document.getElementById('entry-url').value = entry.url || '';
                    // loginUsername is the actual login username, username is the owner
                    document.getElementById('entry-username').value = entry.loginUsername || entry.username || '';
                    document.getElementById('entry-password').value = entry.password || '';
                    document.getElementById('entry-folder').value = entry.folder || 'Alle';
                    document.getElementById('entry-notes').value = entry.notes || '';
                }
            } else {
                title.textContent = 'Neues Passwort';
            }
            
            modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('hidden');
        }

        // ==========================================
        // PASSWORD ENTRY FUNCTIONS
        // ==========================================

        async function savePassword(e) {
            e.preventDefault();
            const id = document.getElementById('entry-id').value;
            const entry = {
                name: document.getElementById('entry-name').value,
                url: document.getElementById('entry-url').value,
                username: document.getElementById('entry-username').value,
                password: document.getElementById('entry-password').value,
                folder: document.getElementById('entry-folder').value,
                notes: document.getElementById('entry-notes').value
            };

            let result;
            if (id) {
                // Update existing - API uses POST with id for upsert
                result = await apiRequest('entries', 'POST', { 
                    id: id,
                    user: currentUser,  // API expects 'user' not 'username' 
                    ...entry 
                });
            } else {
                // Create new
                result = await apiRequest('entries', 'POST', { 
                    user: currentUser,  // API expects 'user' not 'username'
                    ...entry 
                });
            }

            if (result && result.success) {
                closeModal('password-modal');
                await loadEntries();
                showToast(id ? 'Passwort aktualisiert' : 'Passwort erstellt');
            }
        }

        function initiateDeleteEntry(entryId) {
            deleteTarget = { type: 'entry', id: entryId };
            document.getElementById('delete-modal-text').textContent = 'Dieses Passwort wirklich l√∂schen?';
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        async function confirmDelete() {
            if (!deleteTarget) return;
            
            let result;
            if (deleteTarget.type === 'folder') {
                result = await apiRequest('folders', 'DELETE', { username: currentUser, folderName: deleteTarget.id });
                if (result && result.success) {
                    foldersData = foldersData.filter(f => (typeof f === 'string' ? f : f.name) !== deleteTarget.id);
                    if (currentFolder === deleteTarget.id) currentFolder = 'Alle';
                    renderFolders();
                    renderPasswords();
                    showToast('Ordner gel√∂scht');
                }
            } else if (deleteTarget.type === 'entry') {
                // API expects 'id' and 'username' for delete
                result = await apiRequest('entries', 'DELETE', { id: deleteTarget.id, username: currentUser });
                if (result && result.success) {
                    entriesData = entriesData.filter(e => e.id !== deleteTarget.id);
                    renderPasswords();
                    showToast('Passwort gel√∂scht');
                }
            }
            
            closeModal('delete-modal');
            deleteTarget = null;
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generatePassword() {
            // Get length from slider
            const lengthSlider = document.getElementById('pass-length');
            const length = lengthSlider ? parseInt(lengthSlider.value) : 12;
            
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Set password in both fields
            document.getElementById('entry-password').value = password;
            const confirmField = document.getElementById('entry-password-confirm');
            if (confirmField) {
                confirmField.value = password;
            }
            
            updatePasswordStrength(password);
        }

        // Slider event handler for password length
        function initPasswordSlider() {
            const slider = document.getElementById('pass-length');
            const sliderVal = document.getElementById('slider-val');
            
            if (slider && sliderVal) {
                slider.addEventListener('input', function() {
                    sliderVal.textContent = this.value;
                });
            }
        }

        // Initialize slider when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPasswordSlider);
        } else {
            initPasswordSlider();
        }

        function createCardHTML(entry) {
            const faviconUrl = entry.url ? `https://www.google.com/s2/favicons?domain=${entry.url}&sz=32` : '';
            return `
                <div class="bg-darkgray border border-gray-800 rounded-xl p-5 hover:border-gold transition-all">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            ${faviconUrl ? `<img src="${faviconUrl}" class="w-8 h-8 rounded" onerror="this.style.display='none'">` : '<div class="w-8 h-8 bg-gold rounded flex items-center justify-center text-black"><i class="fas fa-key"></i></div>'}
                            <div>
                                <h3 class="font-bold text-white">${entry.name || 'Unbenannt'}</h3>
                                <p class="text-xs text-gray-500">${entry.folder || 'Alle'}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openPasswordModal('${entry.id}')" class="text-gray-500 hover:text-gold p-1"><i class="fas fa-edit"></i></button>
                            <button onclick="initiateDeleteEntry('${entry.id}')" class="text-gray-500 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500">Benutzer:</span>
                            <div class="flex items-center gap-2">
                                <span class="text-white">${entry.loginUsername || entry.username || '-'}</span>
                                <button onclick="copyToClipboard('${entry.loginUsername || entry.username || ''}')" class="text-gray-500 hover:text-gold"><i class="far fa-copy"></i></button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500">Passwort:</span>
                            <div class="flex items-center gap-2">
                                <input type="password" id="pass-display-${entry.id}" value="${entry.password || ''}" readonly class="bg-transparent text-white w-24 text-right">
                                <button onclick="toggleCardPassVisibility('${entry.id}')" class="text-gray-500 hover:text-gold"><i id="eye-icon-${entry.id}" class="fas fa-eye"></i></button>
                                <button onclick="copyToClipboard('${entry.password}')" class="text-gray-500 hover:text-gold"><i class="far fa-copy"></i></button>
                            </div>
                        </div>
                        ${entry.url ? `<a href="${entry.url}" target="_blank" class="text-gold hover:underline text-xs block truncate">${entry.url}</a>` : ''}
                    </div>
                </div>
            `;
        }

        // Event Listeners for Forms - wrapped to handle missing elements gracefully
        function setupEventListeners() {
            const folderForm = document.getElementById('folder-form');
            const passwordForm = document.getElementById('password-form');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const searchInput = document.getElementById('search-input');
            
            if (folderForm) folderForm.addEventListener('submit', createFolder);
            if (passwordForm) passwordForm.addEventListener('submit', savePassword);
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', confirmDelete);
            if (searchInput) searchInput.addEventListener('input', renderPasswords);
        }
        
        // Setup event listeners after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupEventListeners);
        } else {
            setupEventListeners();
        }

        // PASSWORDS
        function renderPasswords() {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const filtered = entriesData.filter(entry => {
                const isFolder = currentFolder === 'Alle' || entry.folder === currentFolder;
                const isSearch = (entry.name || '').toLowerCase().includes(searchTerm) ||
                    (entry.username || '').toLowerCase().includes(searchTerm) ||
                    (entry.url || '').toLowerCase().includes(searchTerm);
                return isFolder && isSearch;
            });

            document.getElementById('current-folder-title').textContent = currentFolder;
            document.getElementById('entry-count').textContent = `${filtered.length} Eintr√§ge`;
            passwordGrid.innerHTML = '';

            if (filtered.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
                filtered.forEach(entry => {
                    passwordGrid.innerHTML += createCardHTML(entry);
                });
            }
        }

        function updatePasswordStrength(password) {
            const meter = document.getElementById('strength-meter');
            const text = document.getElementById('strength-text');

            let score = 0;
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
            if (/\d/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;

            let width, color, status;
            switch (score) {
                case 0:
                case 1:
                    width = '20%'; color = 'bg-red-500'; status = 'Sehr schwach';
                    break;
                case 2:
                    width = '40%'; color = 'bg-orange-500'; status = 'Schwach';
                    break;
                case 3:
                    width = '60%'; color = 'bg-yellow-500'; status = 'Mittel';
                    break;
                case 4:
                    width = '80%'; color = 'bg-blue-500'; status = 'Stark';
                    break;
                case 5:
                    width = '100%'; color = 'bg-green-500'; status = 'Sehr stark';
                    break;
                default:
                    width = '0%'; color = 'bg-gray-500'; status = '';
            }

            meter.className = `h-full strength-bar ${color}`;
            meter.style.width = width;
            text.textContent = `St√§rke: ${status}`;
        }

        function copyToClipboard(text) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => showToast('Kopiert!')).catch(() => showToast('Fehler beim Kopieren', 'error'));
        }

        function toggleVisibility(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        function toggleCardPassVisibility(id) {
            const input = document.getElementById(`pass-display-${id}`);
            const icon = document.getElementById(`eye-icon-${id}`);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-message');
            msg.textContent = message;
            if (type === 'error') {
                toast.classList.remove('border-gold');
                toast.classList.add('border-red-600');
            } else {
                toast.classList.add('border-gold');
                toast.classList.remove('border-red-600');
            }
            toast.classList.remove('translate-x-full');
            setTimeout(() => { toast.classList.add('translate-x-full'); }, 3000);
        }

        // TOTP 2FA Functions
        async function openTotpSetup() {
            const result = await apiRequest('auth', 'POST', { action: 'setup-totp', username: currentUser });
            if (result && result.success) {
                document.getElementById('qr-code-image').src = result.qrCode;
                document.getElementById('totp-secret-display').textContent = result.secret;
                document.getElementById('totp-setup-step1').classList.remove('hidden');
                document.getElementById('totp-setup-step2').classList.add('hidden');
                document.getElementById('totp-setup-modal').classList.remove('hidden');
            } else {
                showToast(result?.message || '2FA Setup fehlgeschlagen', 'error');
            }
        }

        function showTotpVerifyStep() {
            document.getElementById('totp-setup-step1').classList.add('hidden');
            document.getElementById('totp-setup-step2').classList.remove('hidden');
        }

        function closeTotpSetup() {
            document.getElementById('totp-setup-modal').classList.add('hidden');
        }

        // TOTP form handler - only attach if element exists
        const totpVerifyForm = document.getElementById('totp-verify-form');
        if (totpVerifyForm) {
            totpVerifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const code = document.getElementById('totp-verify-code').value;
                const result = await apiRequest('auth', 'POST', { action: 'enable-totp', username: currentUser, code: code });
                if (result && result.success) {
                    showToast('2FA erfolgreich aktiviert!');
                    closeTotpSetup();
                } else {
                    showToast(result?.message || 'Code ung√ºltig', 'error');
                }
            });
        }
    </script>
</body>

</html>